apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cluster
  namespace: redis
spec:
  template:
    spec:
      initContainers:
        - name: init
          image: redis:8.0-M04-alpine3.21
          command: ["sh", "-c"]
          args:
            - |
              for i in 0 1 2; do
                until redis-cli -h redis-$i.redis.redis.svc.cluster.local ping; do
                  echo "Waiting for redis-$i to be ready..."
                  sleep 5
                done
              done
      containers:
        - name: redis
          image: redis:8.0-M04-alpine3.21
          command: ["sh", "-c"]
          args:
            - |
              redis-cli --cluster create \
                redis-0.redis.redis.svc.cluster.local:6379 \
                redis-1.redis.redis.svc.cluster.local:6379 \
                redis-2.redis.redis.svc.cluster.local:6379 \
                --cluster-replicas 0 --cluster-yes
      restartPolicy: OnFailure
  backoffLimit: 4
  ttlSecondsAfterFinished: 60
  activeDeadlineSeconds: 300
